{"version":3,"sources":["../src/AsyncIterable.js"],"names":["IterationError","errorObj","Error","AsyncIterableBase","array","item","push","asyncFunc","i","brkObj","ret","undefined","transformFunc","MapAsyncIterable","filterFunc","FilterAsyncIterable","maxItems","TakeAsyncIterable","Symbol","AsyncIteratorBase","AsyncIterable","innerIterable","asyncItemAwaiterFunction","queueSize","_innerIterable","_asyncItemAwaiterFunction","_queueSize","length","size","asyncIterator","QueuedAsyncIterator","AsyncIterator","asyncIterable","next","_queue","pop","value","empty","done","_start","_asyncIterable","internalItem","close","maxSize","sleepPeriodMs","_innerIterator","iterator","innerAsyncIterable","_innerAsyncIterable","_maxItems","TakeAsyncIterator","innerSize","Math","min","iterable","_nextIndex","_iterable","_innerAsyncIterator","_transformFunc","MapAsyncIterator","_filterFunc","FilterAsyncIterator","StreamIterable","streamFactory","transformer","_streamFactory","_transformer","StreamIterator","stream","streamIterable","_stream","_streamIterable","on","pause","finalItem","resume","errStr"],"mappings":"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","file":"AsyncIterable.js","sourcesContent":["//@flow\r\n\r\nimport Queue from './Queue'\r\n\r\n/***************************************/\r\n\r\nclass IterationError extends Error {\r\n  errorObj: Object\r\n\r\n  constructor(errorObj) {\r\n    super()\r\n    this.errorObj = errorObj\r\n  }\r\n}\r\n\r\n/***************************************/\r\n\r\nclass AsyncIterableBase<T, B> {\r\n  static brkObj = Symbol('brkObj')\r\n\r\n  async toArray(): Array<B> {\r\n    let array = []\r\n    for await (let item of this) {\r\n      array.push(item)\r\n    }\r\n    return array\r\n  }\r\n\r\n  async forEach<Symbol>(asyncFunc: (B, number, Symbol) => Symbol): Promise<void> {\r\n    let i = 0\r\n    for await (let item of this) {\r\n      let ret = await asyncFunc(item, i++, AsyncIterableBase.brkObj)\r\n      if (ret === AsyncIterableBase.brkObj)\r\n        break\r\n    }\r\n  }\r\n\r\n  size(): ?number {\r\n    return undefined\r\n  }\r\n\r\n  map<C>(transformFunc: (B) => C): MapAsyncIterable<T, C> {\r\n    return new MapAsyncIterable(this, transformFunc)\r\n  }\r\n\r\n  filter(filterFunc: (T) => boolean): FilterAsyncIterable<T> {\r\n    return new FilterAsyncIterable(this, filterFunc)\r\n  }\r\n\r\n  take(maxItems: number): TakeAsyncIterable<T> {\r\n    return new TakeAsyncIterable(this, maxItems)\r\n  }\r\n}\r\n\r\nclass AsyncIteratorBase<T, B> {\r\n  async next(): Promise<{ done: false, value: B } | { done: true }> {\r\n    throw new Error('This function must be overridden by derived classes')\r\n  }\r\n}\r\n\r\n/***************************************/\r\n\r\nexport default class AsyncIterable<T, B> extends AsyncIterableBase<T, B> {\r\n  _innerIterable: Iterable<T>\r\n  _asyncItemAwaiterFunction: (T) => Promise<B>\r\n  _queueSize: number\r\n\r\n  constructor(innerIterable: Iterable<T>, asyncItemAwaiterFunction: (T) => Promise<B> = (i) => i, queueSize: number = 0) {\r\n    super()\r\n    this._innerIterable = innerIterable\r\n    this._asyncItemAwaiterFunction = asyncItemAwaiterFunction\r\n    this._queueSize = queueSize\r\n  }\r\n\r\n  size(): ?number {\r\n    return typeof this._innerIterable.length === 'undefined' ? this._innerIterable.size : this._innerIterable.length // if _innerIterable is not a list, undefined will be returned\r\n  }\r\n\r\n  [Symbol.asyncIterator](): AsyncIteratorBase<T, B> {\r\n    return this._queueSize ? new QueuedAsyncIterator(this) : new AsyncIterator(this)\r\n  }\r\n}\r\n\r\nclass QueuedAsyncIterator<T, B> extends AsyncIteratorBase<T, B> {\r\n  _asyncIterable: AsyncIterable<T, B>\r\n  _queue: Queue<B>\r\n\r\n  constructor(asyncIterable: AsyncIterable<T, B>) {\r\n    super()\r\n    this._asyncIterable = asyncIterable\r\n    this._queue = new Queue({ maxSize: this._asyncIterable._queueSize, sleepPeriodMs: 50 })\r\n    this._start()\r\n  }\r\n\r\n  next = async (): Promise<{ done: false, value: B } | { done: true }> => {\r\n    while (true) {\r\n      let value = await this._queue.pop()\r\n      if (value === Queue.empty)\r\n        return { done: true }\r\n      return { done: false, value: value }\r\n    }\r\n  }\r\n\r\n  _start = async () => {\r\n    for (let internalItem of this._asyncIterable._innerIterable) {\r\n      let value = await this._asyncIterable._asyncItemAwaiterFunction(internalItem)\r\n      await this._queue.push(value)\r\n    }\r\n    this._queue.close()\r\n  }\r\n}\r\n\r\nclass AsyncIterator<T, B> extends AsyncIteratorBase<T, B> {\r\n  _asyncIterable: AsyncIterable<T, B>\r\n  _innerIterator: Iterator<T>\r\n\r\n  constructor(asyncIterable: AsyncIterable<T, B>) {\r\n    super()\r\n    this._asyncIterable = asyncIterable\r\n    this._innerIterator = this._asyncIterable._innerIterable[Symbol.iterator]()\r\n  }\r\n\r\n  next = async (): Promise<{ done: false, value: B } | { done: true }> => {\r\n    let next = this._innerIterator.next()\r\n    if (next.done)\r\n      return { done: true }\r\n    let value = await this._asyncIterable._asyncItemAwaiterFunction(next.value)\r\n    return { done: false, value: value }\r\n  }\r\n}\r\n\r\n/***************************************/\r\n\r\nclass TakeAsyncIterable<T> extends AsyncIterableBase<T, T> {\r\n  _innerAsyncIterable: AsyncIterableBase<T, T>\r\n  _maxItems: number\r\n\r\n  constructor(innerAsyncIterable: AsyncIterableBase<T, T>, maxItems: number) {\r\n    super()\r\n    this._innerAsyncIterable = innerAsyncIterable\r\n    this._maxItems = maxItems\r\n  }\r\n\r\n  [Symbol.asyncIterator](): TakeAsyncIterator<T> {\r\n    return new TakeAsyncIterator(this)\r\n  }\r\n\r\n  size(): ?number {\r\n    let innerSize = this._innerAsyncIterable.size()\r\n    if (innerSize != undefined) {\r\n      return Math.min(innerSize, this._maxItems)\r\n    }\r\n  }\r\n}\r\n\r\nclass TakeAsyncIterator<T> extends AsyncIteratorBase<T, T> {\r\n  _iterable: TakeAsyncIterable<T>\r\n  _innerAsyncIterator: AsyncIteratorBase<T, T>\r\n  _maxItems: number\r\n  _nextIndex = 0\r\n\r\n  constructor(iterable: TakeAsyncIterable<T>) {\r\n    super()\r\n    this._iterable = iterable\r\n    this._innerAsyncIterator = this._iterable._innerAsyncIterable[Symbol.asyncIterator]()\r\n  }\r\n\r\n  async next(): Promise<{ done: false, value: T } | { done: true }> {\r\n    if (this._nextIndex >= this._iterable._maxItems)\r\n      return { done: true }\r\n    this._nextIndex++\r\n    return await this._innerAsyncIterator.next()\r\n  }\r\n}\r\n\r\n/***************************************/\r\n\r\nclass MapAsyncIterable<T, B> extends AsyncIterableBase<T, B> {\r\n  _innerAsyncIterable: AsyncIterableBase<T, T>\r\n  _transformFunc: (T) => B\r\n\r\n  constructor(innerAsyncIterable: AsyncIterableBase<T, T>, transformFunc: (T) => B) {\r\n    super()\r\n    this._innerAsyncIterable = innerAsyncIterable\r\n    this._transformFunc = transformFunc\r\n  }\r\n\r\n  [Symbol.asyncIterator](): MapAsyncIterator<T, B> {\r\n    return new MapAsyncIterator(this)\r\n  }\r\n\r\n  size(): ?number {\r\n    return this._innerAsyncIterable.size()\r\n  }\r\n}\r\n\r\nclass MapAsyncIterator<T, B> extends AsyncIteratorBase<T, B> {\r\n  _iterable: MapAsyncIterable<T, B>\r\n  _innerAsyncIterator: AsyncIteratorBase<T, T>\r\n  _maxItems: number\r\n  _nextIndex = 0\r\n\r\n  constructor(iterable: MapAsyncIterable<T, B>) {\r\n    super()\r\n    this._iterable = iterable\r\n    this._innerAsyncIterator = this._iterable._innerAsyncIterable[Symbol.asyncIterator]()\r\n  }\r\n\r\n  async next(): Promise<{ done: false, value: B } | { done: true }> {\r\n    let item = await this._innerAsyncIterator.next()\r\n    if (item.done === true)\r\n      return { done: true }\r\n    let value = await this._iterable._transformFunc(item.value)\r\n    return { value: value, done: false }\r\n  }\r\n}\r\n\r\n/***************************************/\r\n\r\nclass FilterAsyncIterable<T> extends AsyncIterableBase<T, T> {\r\n  _innerAsyncIterable: AsyncIterableBase<T, T>\r\n  _filterFunc: (T) => boolean\r\n\r\n  constructor(innerAsyncIterable: AsyncIterableBase<T, T>, filterFunc: (T) => boolean) {\r\n    super()\r\n    this._innerAsyncIterable = innerAsyncIterable\r\n    this._filterFunc = filterFunc\r\n  }\r\n\r\n  [Symbol.asyncIterator](): FilterAsyncIterator<T> {\r\n    return new FilterAsyncIterator(this)\r\n  }\r\n}\r\n\r\nclass FilterAsyncIterator<T> extends AsyncIteratorBase<T, T> {\r\n  _iterable: FilterAsyncIterable<T>\r\n  _innerAsyncIterator: AsyncIteratorBase<T, T>\r\n  _maxItems: number\r\n  _nextIndex = 0\r\n\r\n  constructor(iterable: FilterAsyncIterable<T>) {\r\n    super()\r\n    this._iterable = iterable\r\n    this._innerAsyncIterator = this._iterable._innerAsyncIterable[Symbol.asyncIterator]()\r\n  }\r\n\r\n  async next(): Promise<{ done: false, value: T } | { done: true }> {\r\n    let item: { done: false, value: T } | { done: true } = { done: true }\r\n    while (true) {\r\n      item = await this._innerAsyncIterator.next()\r\n      if (item.done === true)\r\n        break\r\n      if (await this._iterable._filterFunc(item.value))\r\n        break\r\n    }\r\n    return item\r\n  }\r\n}\r\n\r\n/***************************************/\r\n\r\nexport class StreamIterable<T, B> extends AsyncIterableBase<T, B> {\r\n  _streamFactory: Function\r\n  _transformer: ?(T) => B\r\n\r\n  constructor(streamFactory: Function, transformer: ?(T) => B) {\r\n    super()\r\n    this._streamFactory = streamFactory\r\n    this._transformer = transformer\r\n  }\r\n\r\n  [Symbol.asyncIterator]() {\r\n    return new StreamIterator(this._streamFactory(), this)\r\n  }\r\n}\r\n\r\nexport class StreamIterator<T, B> extends AsyncIteratorBase<T, B> {\r\n  _queue: Queue<B>\r\n  _stream: Object\r\n  _streamIterable: StreamIterable<T, B>\r\n\r\n  constructor(stream: Object, streamIterable: StreamIterable<T, B>) {\r\n    super()\r\n    this._queue = new Queue({ maxSize: 10000 })\r\n    this._stream = stream\r\n    this._streamIterable = streamIterable\r\n    //let stat = startStat('steram item')\r\n    this._stream.on('data', async (item: T) => {\r\n      stream.pause()\r\n      let finalItem = this._transformer ? this._streamIterable._transformer(item) : item\r\n      await this._queue.push(finalItem)\r\n      stream.resume()\r\n      //stat.inc()\r\n    })\r\n    this._stream.on('end', () => {\r\n      this._queue.close()\r\n      //stat.end()\r\n    })\r\n    this._stream.on('error', async (errStr) => {\r\n      await this._queue.push(new IterationError(errStr))\r\n      this._queue.close()\r\n      //stat.end()\r\n    })\r\n  }\r\n\r\n  async next(): Promise<{ done: false, value: B } | { done: true }> {\r\n    let value = await this._queue.pop()\r\n    if (value instanceof IterationError)\r\n      throw value.errorObj\r\n    if (value === Queue.empty) {\r\n      return { done: true }\r\n    }\r\n    return { value: value, done: false }\r\n  }\r\n}\r\n"]}